# ProAssist Development Rules

## Release Process

**CRITICAL: NEVER CREATE RELEASES MANUALLY**

- **NEVER** use `gh release create` or create releases through GitHub UI
- **ONLY** create tags using `git tag` and push them
- The CI/CD workflow will automatically create the release when a tag is pushed
- If you accidentally create a release manually, delete it and recreate only the tag

**BEFORE creating any release tag, you MUST:**

1. **Update CHANGELOG.md** - Always document what changed in this release

   - Add a new section at the top with version number and date
   - Include Added/Changed/Fixed sections as appropriate
   - Commit the changelog update before tagging

2. **Run local build** - Always verify the build passes locally

   ```bash
   npm run build
   ```

   - Fix any TypeScript/build errors before creating a tag
   - Never push a tag if the build fails locally

3. **Update version numbers** in:

   - `src-tauri/tauri.conf.json`
   - `package.json`
   - `src/components/VersionSettings.tsx` (APP_VERSION constant)

4. **Commit all changes** before creating the tag

5. **Create and push tag** only after:
   - ✅ CHANGELOG.md is updated
   - ✅ Local build passes (`npm run build`)
   - ✅ All version numbers are updated
   - ✅ All changes are committed

## Release Workflow

```bash
# 1. Update version numbers
git add src-tauri/tauri.conf.json package.json src/components/VersionSettings.tsx
git commit -m "Bump version to X.Y.Z"
git push origin main

# 2. Update CHANGELOG.md (REQUIRED)
# Edit CHANGELOG.md, then:
git add CHANGELOG.md
git commit -m "Update CHANGELOG for vX.Y.Z"
git push origin main

# 3. Run build locally (REQUIRED)
npm run build

# 4. If build passes, create and push tag (CI/CD will create the release automatically)
git tag -a vX.Y.Z -m "Release version X.Y.Z - Description"
git push origin vX.Y.Z
```

**IMPORTANT**: After pushing the tag, the GitHub Actions workflow will automatically create the release. Do NOT create the release manually.

## If Build Fails After Tagging

If you already pushed a tag with build errors:

1. Delete tag locally: `git tag -d vX.Y.Z`
2. Delete tag remotely: `git push origin --delete vX.Y.Z`
3. Fix build errors and commit
4. Recreate tag: `git tag -a vX.Y.Z -m "Release message"`
5. Push tag again: `git push origin vX.Y.Z`

## Important Reminders

- **NEVER create releases manually** - Only create tags, let CI/CD handle releases
- **Never skip the changelog** - Users need to know what changed
- **Never skip the local build** - CI will fail if build has errors
- **Always update all version files** - Keep them in sync
- **Test before release** - Verify the build works locally first

## If You Accidentally Created a Release Manually

If a release was created manually (via `gh release create` or GitHub UI):

1. Delete the release: `gh release delete vX.Y.Z --yes`
2. Delete the remote tag: `git push origin --delete vX.Y.Z`
3. Create a new tag: `git tag -a vX.Y.Z -m "Release version X.Y.Z - Description"`
4. Push the tag: `git push origin vX.Y.Z`
5. Let CI/CD create the release automatically

## Security Policy (CSP) Updates

**CRITICAL: Always update Content Security Policy when adding external URL features**

When adding any feature that connects to an external URL (API, service, database, etc.), you **MUST** update the Content Security Policy (CSP) in `src-tauri/tauri.conf.json` to allow those connections.

### What Requires CSP Updates

- **External APIs** (OpenAI, AssemblyAI, Google Gemini, Groq, etc.)
- **Database connections** (Firebase Realtime Database, Firestore, etc.)
- **WebSocket connections** to external servers
- **Script loading** from external domains (e.g., Firebase long-polling `.lp` endpoints)
- **Any HTTP/HTTPS request** to a domain outside your app

### CSP Update Checklist

When adding external URL features:

1. **Identify all domains/URLs** the feature will connect to
2. **Update `connect-src`** in `src-tauri/tauri.conf.json` to include:
   - `https://<domain>` or `https://*.<domain>` for subdomains
   - `wss://<domain>` for WebSocket connections
   - Specific paths if needed (e.g., `https://*.firebaseio.com`)

3. **Update `script-src`** if the feature loads external scripts:
   - Add `https://<domain>` or `https://*.<domain>`
   - Example: Firebase RTDB long-polling requires `https://*.firebaseio.com` in `script-src`

4. **Test in production build** - CSP is stricter in release builds
   - Use DevTools (F12 or Settings → Version → Open Inspector) to check for CSP errors
   - Look for "Refused to connect" or "Refused to load" errors in console

### Example: Adding Firebase Support

```json
{
  "app": {
    "security": {
      "csp": "default-src 'self'; script-src 'self' 'unsafe-eval' https://*.firebaseio.com; connect-src 'self' ipc: ipc://localhost http://localhost:* http://127.0.0.1:* ws://localhost:* ws://127.0.0.1:* https: http: ws: wss: https://*.firebaseio.com https://*.firebasedatabase.app wss://*.firebaseio.com wss://*.firebasedatabase.app; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:;"
    }
  }
}
```

### Common CSP Directives

- **`connect-src`**: Controls fetch, XHR, WebSocket, EventSource connections
- **`script-src`**: Controls `<script>` tag sources and `eval()`
- **`style-src`**: Controls `<style>` and `<link rel="stylesheet">` sources
- **`img-src`**: Controls `<img>` and image sources

### Important Notes

- **Tauri IPC** requires `ipc:` and `ipc://localhost` in `connect-src`
- **Localhost connections** should include `http://localhost:*`, `http://127.0.0.1:*`, `ws://localhost:*`, `ws://127.0.0.1:*`
- **Firebase RTDB** requires both `connect-src` (for WebSocket/HTTP) AND `script-src` (for long-polling fallback)
- **Always test in production build** - dev builds may have relaxed CSP

### If CSP Errors Occur

1. Open DevTools (F12 or Settings → Version → Open Inspector)
2. Check Console for "Refused to connect" or "Refused to load" errors
3. Identify which directive is blocking (connect-src, script-src, etc.)
4. Add the required domain/URL pattern to that directive
5. Rebuild and test again

## See Also

- `RELEASE.md` - Complete release documentation
- `.github/workflows/release.yml` - CI/CD workflow configuration
- `src-tauri/tauri.conf.json` - Current CSP configuration